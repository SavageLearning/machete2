version: '3'

networks:
  machete:
    driver: bridge

services:
  db:
    image: postgres:9.6-alpine
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_PASSWORD=postgres
    networks:
      machete:
        aliases:
          - "db"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
  graphite:
    image: graphiteapp/graphite-statsd

    networks:
      machete:
        aliases:
          - "graphite"
    # Uncomment for persistenting data
    volumes:
      # Persistence for metrics data (Whisper database files):
      - './.graphite-storage:/opt/graphite/storage/whisper'
    ports:
      - '80:80'
      - '127.0.0.1:2003:2003'
      - '127.0.0.1:2004:2004'
      - '127.0.0.1:2013:2013'
      - '127.0.0.1:2014:2014'
      - '127.0.0.1:2023:2023'
      - '127.0.0.1:2024:2024'
      - '8080:8080'
      - '127.0.0.1:8125:8125'
      - '127.0.0.1:8126:8126'
  # Web interface for turning Graphite metrics into charts:
  grafana:
    image: grafana/grafana
    networks:
      machete:
        aliases:
          - "grafana"
    depends_on:
      - graphite
    ports:
      - '127.0.0.1:3000:3000' # Grafana web interface (local only to prevent eavesdropping)
    volumes:
      - './grafana/provisioning:/etc/grafana/provisioning'
      - './grafana/dashboards:/etc/dashboards'
    # Uncomment for persistenting data
    #  - './.grafana-storage/data:/var/lib/grafana'
    #  - './.grafana-storage/etc/grafana.ini:/etc/grafana/grafana.ini'
  keycloak:
    image: quay.io/keycloak/keycloak:nightly
    ports:
      - 0.0.0.0:8100:8100
      - 0.0.0.0:8101:8101
    env_file: "./env_variables.conf"
    command: ["start-dev --auto-build --http-port=8100 --https-port=8101 --db=postgres --features=token-exchange --db-url=jdbc:postgresql://db:5432/keycloak --db-username=postgres --db-password=postgres --import-realm"]
    volumes:
      - './keycloak-test-realm.json:/opt/keycloak/data/import/keycloak-test-realm.json'
    networks:
      machete:
        aliases:
          - "keycloak"
    depends_on:
      - db
